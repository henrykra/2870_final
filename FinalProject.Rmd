---
title: "Final Project CS 2870"
author: "Skyler Heininger, Andy English, Henry Kraessig"
date: "11/29/2023"
output: html_document
---

## Set up
```{r setup, message = FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.align = "center")
pacman::p_load(rpart, rpart.plot, tidyverse, caret)

theme_set(theme_bw())
```

STAT/CS 2870 Project Draft
Skyler Heininger, Henry Kraessig, Andy English

## I. Introduction
	
This project focused on analyzing MLB pitch data from 2018. This data was generated by the MLB from sensor data during MLB games in 2018. This data is a sample because it is all games within the MLB during the 2018 season. Any other teams not in the MLB are not included. This could provide some sort of sampling bias towards the average pitch within this dataset being “better” than the average pitch in general, due to the professional level of the MLB. However, if we are just analyzing this data based on the context of the MLB, then there is no sampling bias since this dataset contains all pitches thrown within the 2018 season. This is clearly an observational study since it is gathering data from an already-established practice without manipulating any variables intentionally. The measurements taken were done using sensors. To handle bias, we assume the measurements were taken the same for every single pitch, at every game, at every stadium during the 2018 MLB season. Really, we are treating the measurements taken as being purely objective and performed in the same manner for every pitch. As such, we do not anticipate any bias within the measurements. This dataset is extremely interesting due to the pure amount of data present about each pitch and how a pitcher could be classified for applications in scouting, player evaluation, and player development. Finally, data cleaning was necessary to achieve a usable dataset. This was because the data came in the form of a 2015-2018 dataset, which was extremely large and took long periods of time to run. As such, this dataset was filtered down to a 2018 dataset. Code Chunk 1 displays the code necessary for processing this data.

```{r Code Chunk 1: data loading and cleaning}

library(tidyverse)
# Load all data relevant to the pitches
pitches <- read.csv("data/pitches.csv")
abs <- read.csv("data/atbats.csv")
names <- read.csv("data/player_names.csv")
games <- read.csv("data/games.csv")

# Join pitches and at bat, filter for 2018
p_2018 <- 
  pitches |> 
  left_join(
    y = abs,
    by = "ab_id"
  ) |> 
  filter(
    g_id >= 201800000
  )

# Join pitches/atbat with batter names dataset
p_2018_names <-
  p_2018 |> 
  left_join(
    y = names,
    by = c("batter_id" = "id"),
    keep = F
  )

# Make full batter name using first name and last name
p_2018_names_2 <-
  p_2018_names |> 
  mutate(batter_name = paste(first_name, last_name))

# join pitcher names into dataset
p_2018_names_3 <-
  p_2018_names_2 |> 
  left_join(
    y = names,
    by = c("pitcher_id" = "id"),
    keep = F
  )

# Make full name for pitchers, remove 
# individual first and last names
pitches_2018_full <-
  p_2018_names_3 |> 
  mutate(pitcher_name = paste(first_name.y, 
                              last_name.y)) |> 
  select(-first_name.x, -first_name.y, 
         -last_name.x, -last_name.y)

# Save dataset
write.csv(pitches_2018_full, "data/2018_pitches_full.csv", 
          row.names = F, 
          quote = F)

```

## II. Data Visualizations
	One of the relationships we wanted to pursue was the differences in spin rate and angle break between different pitch types. Spin rate is how fast the ball is spinning around its axis, in rotations per minute. The angle break is the angle in degrees of deviation from the theoretical path of the baseball, if it continued to fly in a directly straight line.


```{r spin break}
pitches_spin_cleaned <- pitches |>
  mutate(pitch_type = ifelse(pitch_type == "FO","PO", pitch_type)) |>
  filter(!pitch_type %in% c("", "AB","EP","PO"))

pitches_filtered <- pitches_spin_cleaned |>
  filter(
    abs(spin_rate - summary_stats$spin_rate_mean) <= threshold * summary_stats$spin_rate_sd,
    abs(break_angle - summary_stats$break_angle_mean) <= threshold * summary_stats$break_angle_sd,
    abs(pfx_x - summary_stats$pfx_x_mean) <= threshold * summary_stats$pfx_x_sd,
    abs(pfx_z - summary_stats$pfx_z_mean) <= threshold * summary_stats$pfx_z_sd,
    abs(end_speed - summary_stats$end_speed_mean) <= threshold * summary_stats$end_speed_sd,
    abs(start_speed - summary_stats$start_speed_mean) <= threshold * summary_stats$start_speed_sd
  )

renamed_pitches_clean <- pitches_filtered |>
  mutate(updated_pitch_type = recode(
    pitch_type,
    "CH" = "Changeup",
    "CU" = "Curveball",
    "FC" = "Cutter",
    "FF" = "Four-seam Fastball",
    "FS" = "Splitter",
    "FT" = "Two-seam Fastball",
    "KC" = "Knuckle curve",
    "KN" = "Knuckleball",
    "SCy" = "Screwball",
    "SI" = "Sinker",
    "SL" = "Slider"
  ))

# Plotting the spin rate with break angle, by each pitch type - This could be interesting to include since it contains a neat graph: the amount of angle break is bounded by what is possible. As shown above, this is mirrored in horizontal movement during flight, and somewhat vertical movement (pfx_x and pfx_z, respectively)
ggplot(data = renamed_pitches_clean, mapping = aes(x = spin_rate, y = break_angle, color = updated_pitch_type)) +
  geom_point(show.legend = F, alpha = 0.15) + # Low alpha to allow you to see densities of points
  facet_wrap(facets = ~updated_pitch_type) +
  labs(x = "Spin Rate (RPM)", y = "Break Angle (Degrees)", # need double check on degrees
       title = "Spin Rate and Break Angle for Each Pitch Type") + 
  theme(plot.title = element_text(hjust = 0.5))

```

